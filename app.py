import streamlit as st
import pandas as pd
import gspread
import datetime
import plotly.express as px
import os

# --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ Cloud", page_icon="üí∏", layout="wide")

# --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets (‡∏â‡∏ö‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î) ---
def get_worksheet():
    # ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏´‡∏°‡πà: ‡πÉ‡∏ä‡πâ gspread.service_account() ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô oauth2client
    try:
        # 1. ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå credentials.json ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô
        if os.path.exists("credentials.json"):
            gc = gspread.service_account(filename="credentials.json")
        
        # 2. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å Secrets (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Cloud)
        elif "gcp_service_account" in st.secrets:
            creds_dict = dict(st.secrets["gcp_service_account"])
            gc = gspread.service_account_from_dict(creds_dict)
            
        else:
            st.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå credentials.json ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö app.py ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà")
            st.stop()

        # ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Sheet
        # -------------------------------------------------------
        # ‡πÄ‡∏≠‡∏≤‡∏•‡∏¥‡∏á‡∏Å‡πå Google Sheets ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á xxxxx ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ
        # ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏Ñ‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ü‡∏±‡∏ô‡∏´‡∏ô‡∏π " " ‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡∏´‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö
        sheet_url = "https://docs.google.com/spreadsheets/d/1FbKe-hHVNi7Suo_XlP06qa8kcItPAoQzNNOFvsK38Ss/edit?gid=0#gid=0" 
        # -------------------------------------------------------
        
        return gc.open_by_url(sheet_url).sheet1
        
    except Exception as e:
        st.error(f"‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: {e}")
        st.info("üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå Google Sheets ‡∏Ñ‡∏∑‡∏≠ 'ExpenseData' ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÅ‡∏•‡∏∞‡πÅ‡∏ä‡∏£‡πå‡πÉ‡∏´‡πâ Bot ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á")
        st.stop()

# --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
sheet = get_worksheet()
try:
    data = sheet.get_all_records()
    df = pd.DataFrame(data)
except Exception as e:
    # ‡∏Å‡∏£‡∏ì‡∏µ Sheet ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏¥‡∏î
    st.warning("‚ö†Ô∏è ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏≠‡∏≤‡∏à‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤")
    df = pd.DataFrame(columns=["Date", "Time", "Type", "Account", "Channel", "Amount", "Note"])

# ================= ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (Frontend) =================

st.title("üí∏ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (Sync Real-time)")

# --- 1. ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Sidebar) ---
st.sidebar.header("üìù ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà")
with st.sidebar.form("expense_form", clear_on_submit=True):
    date_val = st.date_input("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", datetime.datetime.now())
    
    col_h, col_m = st.columns(2)
    now = datetime.datetime.now()
    with col_h: hour = st.number_input("‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á", 0, 23, now.hour)
    with col_m: minute = st.number_input("‡∏ô‡∏≤‡∏ó‡∏µ", 0, 59, now.minute)
    
    tx_type = st.radio("‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó", ["‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢", "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö"], horizontal=True)
    account = st.selectbox("‡∏ö‡∏±‡∏ç‡∏ä‡∏µ", ["‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢", "‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö", "‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï"])
    channel = st.selectbox("‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á", ["K PLUS", "SCB Easy", "Scan QR", "‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î", "‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï"])
    
    amount = st.number_input("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)", min_value=0.0, format="%.2f")
    note = st.text_input("‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏")
    
    submitted = st.form_submit_button("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
    
    if submitted:
        dt_str = date_val.strftime("%Y-%m-%d")
        tm_str = f"{hour:02}:{minute:02}:00"
        
        # ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Google Sheets
        try:
            sheet.append_row([dt_str, tm_str, tx_type, account, channel, amount, note])
            st.success("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!")
            # ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Google Update ‡∏ó‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
            import time
            time.sleep(1) 
            st.rerun()
        except Exception as e:
            st.error(f"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {e}")

# --- 2. ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Dashboard ---
if not df.empty and 'Amount' in df.columns:
    # ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    df['Amount'] = pd.to_numeric(df['Amount'], errors='coerce').fillna(0)
    
    inc = df[df['Type'] == '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö']['Amount'].sum()
    exp = df[df['Type'] == '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢']['Amount'].sum()
    
    c1, c2, c3 = st.columns(3)
    c1.metric("‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°", f"{inc:,.2f} ‡∏ø", delta="‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö")
    c2.metric("‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°", f"{exp:,.2f} ‡∏ø", delta="-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢", delta_color="inverse")
    c3.metric("‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠", f"{inc - exp:,.2f} ‡∏ø")
    
    st.divider()
    
    col_chart1, col_chart2 = st.columns([2, 1])
    with col_chart1:
        st.subheader("üìä ‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô")
        if not df.empty:
            daily = df.groupby(['Date', 'Type'])['Amount'].sum().reset_index()
            fig = px.bar(daily, x='Date', y='Amount', color='Type', 
                         color_discrete_map={'‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö':'#4CAF50', '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢':'#EF5350'}, barmode='group')
            st.plotly_chart(fig, use_container_width=True)
            
    with col_chart2:
        st.subheader("üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î")
        st.dataframe(df.sort_index(ascending=False).head(10), use_container_width=True)

else:
    st.info("üëã ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö! ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏ô‡∏π‡∏ã‡πâ‡∏≤‡∏¢‡∏°‡∏∑‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö")